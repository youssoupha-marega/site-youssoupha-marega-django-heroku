name: Deploy to Heroku

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:  # ðŸ‘ˆ dispo pour TOUTES les Ã©tapes du job
      HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
      HEROKU_APP_NAME: ${{ secrets.HEROKU_APP_NAME }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # âœ… INSTALLATION DU CLI HEROKU
      - name: Install Heroku CLI
        run: curl https://cli-assets.heroku.com/install.sh | sh

      # âœ… VÃ‰RIFIER QUE HEROKU EST INSTALLÃ‰
      - name: Check Heroku CLI version
        run: heroku --version

      # âœ… VÃ‰RIFIER L'AUTHENTIFICATION
      - name: Check Heroku auth
        run: heroku auth:whoami || echo "Not logged in, using HEROKU_API_KEY"

      # âœ… LOGIN REGISTRY VIA CLI (plus simple)
      - name: Login to Heroku Container Registry
        run: heroku container:login

      # âœ… CONSTRUIRE ET PUSHER L'IMAGE DOCKER
      - name: Build and Push Docker Image to Heroku
        run: heroku container:push web --app $HEROKU_APP_NAME

      # âœ… LANCER L'IMAGE SUR HEROKU
      - name: Release Docker Image on Heroku
        run: heroku container:release web --app $HEROKU_APP_NAME